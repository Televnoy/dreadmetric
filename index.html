<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#111827">
    
    <!-- PWA Icons - Ожидаются в корневом каталоге GitHub -->
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="apple-touch-icon" href="icon-192.png">
    <link rel="manifest" href="manifest.json">

    <title>DreadMetric | Professional Tool</title>
    
    <script src="https://unpkg.com/@vkontakte/vk-bridge/dist/browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tailwindcss-cdn@3.4.1/tailwindcss.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100;200;300;400;500;600&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --charcoal: #111827;
            --soft-gray: #9CA3AF;
            --border: #E5E7EB;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #FFFFFF;
            color: var(--charcoal);
            -webkit-font-smoothing: antialiased;
            -webkit-tap-highlight-color: transparent;
        }

        .hidden { display: none !important; }

        /* Восстановление оригинального дизайна ползунков из idex all.html */
        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 1px;
            background: var(--border);
            outline: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #FFFFFF;
            border: 1px solid #000000;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        input[type="range"]:active::-webkit-slider-thumb {
            transform: scale(1.2);
            background: #000000;
        }

        .fade-in {
            animation: fadeIn 0.8s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .active-tab {
            background-color: var(--charcoal);
            color: #FFFFFF;
        }

        #trialBanner {
            position: fixed; top: 0; left: 0; width: 100%; padding: 8px;
            background: #000; color: #fff; font-size: 10px;
            text-transform: uppercase; letter-spacing: 0.2em;
            text-align: center; z-index: 9999;
        }
    </style>
</head>
<body class="overflow-x-hidden">

    <div id="trialBanner" class="hidden">Тестовый доступ: осталось <span id="timeLeft">60</span> сек.</div>

    <!-- Экран активации ключа -->
    <div id="authScreen" class="fixed inset-0 z-[1000] bg-white flex flex-col items-center justify-center p-8 hidden">
        <div class="text-[0.6rem] tracking-[0.6em] uppercase font-black mb-4 opacity-20">DreadMetric Studio</div>
        <h2 class="text-4xl font-thin mb-12 tracking-tighter text-center">Активация</h2>
        
        <div class="w-full max-w-xs space-y-4">
            <input id="keyInput" type="text" placeholder="ЛИЦЕНЗИОННЫЙ КЛЮЧ" 
                class="w-full p-6 border border-gray-100 rounded-3xl text-center uppercase tracking-[0.3em] text-[11px] outline-none focus:border-black transition-all bg-gray-50 font-bold">
            <p id="loginError" class="text-red-500 text-[10px] uppercase text-center font-bold tracking-tight h-4"></p>
            <button onclick="validateLicense()" id="loginBtn" 
                class="w-full bg-black text-white p-6 text-[11px] font-bold uppercase tracking-[0.3em] rounded-3xl active:scale-95 transition-all shadow-2xl">
                Подтвердить
            </button>
        </div>
    </div>

    <!-- Главное приложение -->
    <div id="mainApp" class="max-w-md mx-auto min-h-screen flex flex-col fade-in">
        <header class="p-6 pt-12 flex justify-between items-center bg-white/80 backdrop-blur-md sticky top-0 z-40 border-b border-gray-50">
            <div class="flex items-center gap-2">
                <div class="w-1.5 h-1.5 bg-black rounded-full"></div>
                <h1 class="text-[0.7rem] font-black uppercase tracking-[0.5em]">DreadMetric</h1>
            </div>
            <!-- Кнопка настроек в виде шестеренки -->
            <button onclick="toggleSettings(true)" class="p-2 opacity-40 hover:opacity-100 transition-opacity">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="black" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="3"></circle>
                    <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                </svg>
            </button>
        </header>

        <main class="flex-grow p-6 pt-10 space-y-16">
            <section class="fade-in">
                <div class="flex bg-gray-100 p-1.5 rounded-3xl">
                    <button id="btnCr" onclick="setSvc('creation')" class="flex-1 py-4 text-[9px] font-bold uppercase tracking-widest rounded-2xl transition-all active-tab">Плетение</button>
                    <button id="btnCo" onclick="setSvc('correction')" class="flex-1 py-4 text-[9px] font-bold uppercase tracking-widest rounded-2xl transition-all text-gray-400">Коррекция</button>
                </div>
            </section>

            <section class="space-y-16">
                <div class="space-y-6">
                    <div class="flex justify-between items-end">
                        <span class="text-[9px] uppercase tracking-[0.3em] text-gray-400 font-bold">Количество</span>
                        <div class="text-4xl font-thin tracking-tighter"><span id="cVal">50</span><span class="text-[10px] ml-1 opacity-20">шт</span></div>
                    </div>
                    <input type="range" id="cRange" min="1" max="150" value="50" oninput="calculateTotal()">
                </div>

                <div id="lGroup" class="space-y-6">
                    <div class="flex justify-between items-end">
                        <span class="text-[9px] uppercase tracking-[0.3em] text-gray-400 font-bold">Длина волос (см)</span>
                        <div class="text-4xl font-thin tracking-tighter"><span id="lVal">10</span><span class="text-[10px] ml-1 opacity-20">см</span></div>
                    </div>
                    <input type="range" id="lRange" min="5" max="100" value="10" oninput="calculateTotal()">
                </div>
            </section>

            <section class="space-y-8 pt-10 border-t border-gray-100">
                <div class="text-[8px] uppercase tracking-[0.4em] text-gray-300 font-black mb-4">Дополнительно</div>
                <label class="flex items-center justify-between cursor-pointer group">
                    <span class="text-[10px] uppercase font-bold tracking-widest">Тупой кончик</span>
                    <input type="checkbox" id="blunt" onchange="calculateTotal()" class="w-6 h-6 accent-black rounded-full">
                </label>
                <label class="flex items-center justify-between cursor-pointer group">
                    <span class="text-[10px] uppercase font-bold tracking-widest">Прикорневое валяние</span>
                    <input type="checkbox" id="root" onchange="calculateTotal()" class="w-6 h-6 accent-black rounded-full">
                </label>
            </section>
        </main>

        <footer class="p-10 pb-16 bg-white/90 backdrop-blur-xl border-t border-black sticky bottom-0 z-40">
            <div class="max-w-md mx-auto text-center">
                <span class="text-[8px] uppercase tracking-[0.5em] text-gray-400 block font-black mb-3">ИТОГОВАЯ СТОИМОСТЬ</span>
                <div class="flex items-baseline justify-center">
                    <span id="totalPrice" class="text-7xl font-thin tracking-tighter">0</span>
                    <span class="text-2xl ml-4 opacity-10 font-light">₽</span>
                </div>
            </div>
        </footer>
    </div>

    <!-- Модальное окно настроек -->
    <div id="setModal" class="fixed inset-0 z-[2000] bg-white hidden p-10 overflow-y-auto">
        <div class="max-w-md mx-auto">
            <div class="flex justify-between items-center mb-16">
                <span class="text-[0.7rem] font-black uppercase tracking-[0.5em] text-gray-300">Прайс-лист</span>
                <button onclick="toggleSettings(false)" class="text-5xl font-thin">&times;</button>
            </div>
            <div id="priceInputs" class="space-y-10"></div>
            <button onclick="saveToCloud()" id="saveBtn" class="w-full bg-black text-white p-7 uppercase font-black text-[9px] tracking-[0.4em] mt-16 rounded-3xl shadow-2xl active:scale-95 transition-all">
                Синхронизировать
            </button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";

        // Firebase конфиг
        const firebaseConfig = {
            apiKey: "AIzaSyBk99RmIn2McXhLlMV4huc2iTUGONc7Zig",
            authDomain: "rootscalc-1c302.firebaseapp.com",
            projectId: "rootscalc-1c302",
            storageBucket: "rootscalc-1c302.firebasestorage.app",
            messagingSenderId: "466620468252",
            appId: "1:466620468252:web:e65ad3b731f4315f06a3d9"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let svc = 'creation', activeKey = null;
        let config = { p_base: 300, p_step: 200, p_corr: 150, p_blunt: 50, p_root: 30 };
        let trialActive = true;
        let trialSeconds = 60;

        const getRef = (k) => doc(db, 'artifacts', 'rootscalc-pro', 'public', 'data', 'keys', k);

        // Оригинальный звуковой движок
        function playSfx(type) {
            try {
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                if (ctx.state === 'suspended') ctx.resume();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                if(type === 'tick') {
                    osc.frequency.setValueAtTime(580, ctx.currentTime);
                    osc.frequency.exponentialRampToValueAtTime(80, ctx.currentTime + 0.04);
                    gain.gain.setValueAtTime(0.04, ctx.currentTime);
                } else {
                    osc.frequency.setValueAtTime(420, ctx.currentTime);
                    osc.frequency.exponentialRampToValueAtTime(750, ctx.currentTime + 0.12);
                    gain.gain.setValueAtTime(0.02, ctx.currentTime);
                }
                gain.gain.linearRampToValueAtTime(0, ctx.currentTime + 0.1);
                osc.connect(gain); gain.connect(ctx.destination);
                osc.start(); osc.stop(ctx.currentTime + 0.15);
            } catch(e) {}
        }

        // Логика временного доступа
        function startTrial() {
            const savedKey = localStorage.getItem('dm_saved_key');
            if (savedKey) { validateLicense(savedKey); return; }
            document.getElementById('trialBanner').classList.remove('hidden');
            const timer = setInterval(() => {
                if (!trialActive) { clearInterval(timer); return; }
                trialSeconds--;
                document.getElementById('timeLeft').innerText = trialSeconds;
                if (trialSeconds <= 0) { clearInterval(timer); showAuth(); }
            }, 1000);
        }

        function showAuth() {
            document.getElementById('trialBanner').classList.add('hidden');
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('authScreen').classList.remove('hidden');
        }

        window.validateLicense = async (forcedKey = null) => {
            const key = forcedKey || document.getElementById('keyInput').value.trim().toUpperCase();
            if(!key) return;
            if(!forcedKey) playSfx('bubble');
            const btn = document.getElementById('loginBtn');
            const err = document.getElementById('loginError');
            if(!forcedKey) btn.disabled = true;

            try {
                await signInAnonymously(auth);
                const snap = await getDoc(getRef(key));
                if(!snap.exists()) {
                    if(!forcedKey) { err.innerText = "Ключ не найден"; btn.disabled = false; }
                    if(forcedKey) showAuth(); return;
                }
                const data = snap.data();
                let devId = localStorage.getItem('dm_dev_id') || crypto.randomUUID();
                localStorage.setItem('dm_dev_id', devId);

                if(!data.boundDeviceId || data.boundDeviceId === devId) {
                    if(!data.boundDeviceId) await updateDoc(getRef(key), { boundDeviceId: devId, activatedAt: new Date() });
                    activeKey = key; trialActive = false;
                    if(data.config) config = data.config;
                    localStorage.setItem('dm_saved_key', key);
                    document.getElementById('authScreen').classList.add('hidden');
                    document.getElementById('trialBanner').classList.add('hidden');
                    document.getElementById('mainApp').classList.remove('hidden');
                    renderInputs(); calculateTotal();
                } else {
                    if(!forcedKey) { err.innerText = "Ключ уже привязан к другому устройству"; btn.disabled = false; }
                    if(forcedKey) showAuth();
                }
            } catch(e) { if(!forcedKey) { err.innerText = "Ошибка соединения"; btn.disabled = false; } }
        };

        window.calculateTotal = () => {
            playSfx('tick');
            const c = parseInt(document.getElementById('cRange').value);
            const l = parseInt(document.getElementById('lRange').value);
            document.getElementById('cVal').innerText = c;
            document.getElementById('lVal').innerText = l;
            
            let total = 0;
            if(svc === 'creation') {
                let p = config.p_base;
                if(l > 10) p += Math.ceil((l - 10) / 10) * config.p_step;
                total = c * p;
                if(document.getElementById('blunt').checked) total += c * config.p_blunt;
            } else { total = c * config.p_corr; }
            if(document.getElementById('root').checked) total += c * config.p_root;

            const display = document.getElementById('totalPrice');
            const startVal = parseInt(display.innerText.replace(/\s/g, '')) || 0;
            const duration = 400;
            const startTime = performance.now();
            
            function update(t) {
                const elapsed = t - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const easeOut = 1 - Math.pow(1 - progress, 3);
                const current = Math.floor(startVal + (total - startVal) * easeOut);
                display.innerText = current.toLocaleString();
                if(progress < 1) requestAnimationFrame(update);
            }
            requestAnimationFrame(update);
        };

        window.setSvc = (s) => {
            playSfx('bubble'); svc = s;
            document.getElementById('btnCr').className = s === 'creation' ? 'flex-1 py-4 text-[9px] font-bold uppercase tracking-widest rounded-2xl transition-all active-tab' : 'flex-1 py-4 text-[9px] font-bold uppercase tracking-widest rounded-2xl transition-all text-gray-400';
            document.getElementById('btnCo').className = s === 'correction' ? 'flex-1 py-4 text-[9px] font-bold uppercase tracking-widest rounded-2xl transition-all active-tab' : 'flex-1 py-4 text-[9px] font-bold uppercase tracking-widest rounded-2xl transition-all text-gray-400';
            document.getElementById('lGroup').classList.toggle('hidden', s === 'correction');
            calculateTotal();
        };

        window.toggleSettings = (v) => { playSfx('bubble'); document.getElementById('setModal').classList.toggle('hidden', !v); };

        function renderInputs() {
            const box = document.getElementById('priceInputs');
            const labels = { p_base: 'Базовая цена', p_step: 'Шаг длины (+10см)', p_corr: 'Коррекция (шт)', p_blunt: 'Кончик (шт)', p_root: 'Валяние (шт)' };
            box.innerHTML = Object.keys(config).map(k => `
                <div class="flex justify-between items-center border-b border-gray-50 pb-5">
                    <span class="text-[9px] uppercase font-black text-gray-400 tracking-widest">${labels[k]}</span>
                    <input type="number" id="inp_${k}" value="${config[k]}" class="text-right w-24 outline-none font-bold text-xl bg-transparent">
                </div>
            `).join('');
        }

        window.saveToCloud = async () => {
            playSfx('bubble');
            const b = document.getElementById('saveBtn');
            b.innerText = "ОБРАБОТКА...";
            Object.keys(config).forEach(k => config[k] = parseInt(document.getElementById('inp_'+k).value) || 0);
            try {
                await updateDoc(getRef(activeKey), { config: config });
                toggleSettings(false); calculateTotal();
            } catch(e) { alert("Ошибка доступа"); showAuth(); }
            b.innerText = "СИНХРОНИЗИРОВАТЬ";
        };

        window.onload = startTrial;
    </script>
</body>
</html>
