<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#111827">
    
    <!-- Иконки для PWA и браузера -->
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="apple-touch-icon" href="icon-192.png">
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">
    <link rel="manifest" href="manifest.json">

    <title>DreadMetric | Professional Tool</title>
    
    <script src="https://unpkg.com/@vkontakte/vk-bridge/dist/browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tailwindcss-cdn@3.4.1/tailwindcss.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100;200;300;400;500;600&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --charcoal: #111827;
            --soft-gray: #9CA3AF;
            --border: #E5E7EB;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #FFFFFF;
            color: var(--charcoal);
            -webkit-font-smoothing: antialiased;
            -webkit-tap-highlight-color: transparent;
        }

        .hidden { display: none !important; }

        /* Дизайн ползунков из оригинала */
        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 1px;
            background: var(--border);
            outline: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            background: #FFFFFF;
            border: 0.5px solid #E5E7EB;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            border-radius: 50%;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        input[type="range"]:active::-webkit-slider-thumb {
            transform: scale(1.1);
        }

        .fade-in { animation: fadeIn 0.6s ease-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(4px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .tab-active {
            background-color: var(--charcoal);
            color: #FFFFFF;
        }

        input[type="checkbox"] {
            appearance: none;
            width: 44px;
            height: 24px;
            background: #F3F4F6;
            border-radius: 20px;
            position: relative;
            cursor: pointer;
            transition: background 0.3s;
        }
        input[type="checkbox"]:checked {
            background: #000;
        }
        input[type="checkbox"]::after {
            content: '';
            position: absolute;
            top: 2px; left: 2px;
            width: 20px; height: 20px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s;
        }
        input[type="checkbox"]:checked::after {
            transform: translateX(20px);
        }

        #trialLabel {
            position: fixed; top: 0; left: 0; width: 100%; height: 3px;
            background: #000; z-index: 10000; transition: width 1s linear;
        }
    </style>
</head>
<body class="overflow-x-hidden">

    <div id="trialLabel" class="hidden"></div>

    <!-- ЭКРАН АВТОРИЗАЦИИ -->
    <div id="authScreen" class="fixed inset-0 z-[5000] bg-white flex flex-col items-center justify-center p-8 hidden">
        <div class="text-[0.6rem] tracking-[0.5em] uppercase font-black mb-10 opacity-10">DreadMetric Security</div>
        <div class="w-full max-w-xs space-y-6">
            <h2 class="text-3xl font-thin tracking-tighter text-center">Лицензия</h2>
            <input id="keyInput" type="text" placeholder="XXXX-XXXX-XXXX" 
                class="w-full p-5 border border-gray-100 rounded-2xl text-center uppercase tracking-widest text-xs outline-none focus:border-black transition-all bg-gray-50">
            <p id="loginError" class="text-red-500 text-[9px] uppercase text-center font-bold tracking-tight h-4"></p>
            <button onclick="validateLicense()" id="loginBtn" 
                class="w-full bg-black text-white p-5 text-[10px] font-bold uppercase tracking-[0.2em] rounded-2xl active:scale-95 transition-all">
                Активировать
            </button>
        </div>
    </div>

    <!-- ОСНОВНОЙ ИНТЕРФЕЙС -->
    <div id="mainApp" class="max-w-md mx-auto min-h-screen flex flex-col fade-in">
        <header class="p-6 pt-12 flex justify-between items-center bg-white/80 backdrop-blur-md sticky top-0 z-40">
            <div class="flex items-center gap-2">
                <div class="w-2 h-2 bg-black rounded-full"></div>
                <h1 class="text-[0.75rem] font-black uppercase tracking-[0.4em]">DreadMetric</h1>
            </div>
            <button onclick="toggleSettings(true)" class="p-2 opacity-30 hover:opacity-100 transition-opacity">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
            </button>
        </header>

        <main class="flex-grow p-6 pt-6 space-y-12">
            <div class="flex bg-gray-50 p-1 rounded-2xl border border-gray-100">
                <button id="btnCr" onclick="setSvc('creation')" class="flex-1 py-4 text-[10px] font-bold uppercase tracking-widest rounded-xl transition-all tab-active">Плетение</button>
                <button id="btnCo" onclick="setSvc('correction')" class="flex-1 py-4 text-[10px] font-bold uppercase tracking-widest rounded-xl transition-all text-gray-400">Коррекция</button>
            </div>

            <div class="space-y-12">
                <div class="group">
                    <div class="flex justify-between items-end mb-4">
                        <span class="text-[10px] uppercase tracking-[0.2em] text-gray-400 font-bold">Количество</span>
                        <div class="text-4xl font-thin tracking-tighter"><span id="cVal">50</span><span class="text-xs ml-1 opacity-20">шт</span></div>
                    </div>
                    <input type="range" id="cRange" min="1" max="150" value="50" oninput="calculateTotal()">
                </div>

                <div id="lGroup" class="group">
                    <div class="flex justify-between items-end mb-4">
                        <span class="text-[10px] uppercase tracking-[0.2em] text-gray-400 font-bold">Длина волос</span>
                        <div class="text-4xl font-thin tracking-tighter"><span id="lVal">10</span><span class="text-xs ml-1 opacity-20">см</span></div>
                    </div>
                    <input type="range" id="lRange" min="5" max="100" value="10" oninput="calculateTotal()">
                </div>
            </div>

            <div class="pt-8 border-t border-gray-50 space-y-6">
                <label class="flex items-center justify-between py-2 cursor-pointer">
                    <span class="text-[11px] uppercase font-bold tracking-widest">Тупой кончик</span>
                    <input type="checkbox" id="blunt" onchange="calculateTotal()">
                </label>
                <label class="flex items-center justify-between py-2 cursor-pointer">
                    <span class="text-[11px] uppercase font-bold tracking-widest">Прикорневое валяние</span>
                    <input type="checkbox" id="root" onchange="calculateTotal()">
                </label>
            </div>
        </main>

        <footer class="p-8 pb-12 bg-white sticky bottom-0 border-t border-black z-40">
            <div class="flex flex-col items-center">
                <span class="text-[9px] uppercase tracking-[0.4em] text-gray-400 font-black mb-2">Общая стоимость</span>
                <div class="flex items-baseline">
                    <span id="totalPrice" class="text-6xl font-thin tracking-tighter">0</span>
                    <span class="text-xl ml-3 opacity-20 font-light">₽</span>
                </div>
            </div>
        </footer>
    </div>

    <!-- НАСТРОЙКИ -->
    <div id="setModal" class="fixed inset-0 z-[6000] bg-white hidden p-8 overflow-y-auto">
        <div class="max-w-md mx-auto">
            <div class="flex justify-between items-center mb-12">
                <span class="text-[0.7rem] font-black uppercase tracking-[0.5em] text-gray-300">Настройки цен</span>
                <button onclick="toggleSettings(false)" class="text-4xl font-thin">&times;</button>
            </div>
            <div id="priceInputs" class="space-y-8"></div>
            <button onclick="saveToCloud()" id="saveBtn" 
                class="w-full bg-black text-white p-6 uppercase font-black text-[10px] tracking-[0.3em] mt-12 rounded-2xl shadow-xl active:scale-95 transition-all">
                Сохранить в облако
            </button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBk99RmIn2McXhLlMV4huc2iTUGONc7Zig",
            authDomain: "rootscalc-1c302.firebaseapp.com",
            projectId: "rootscalc-1c302",
            storageBucket: "rootscalc-1c302.firebasestorage.app",
            messagingSenderId: "466620468252",
            appId: "1:466620468252:web:e65ad3b731f4315f06a3d9"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let svc = 'creation', activeKey = null;
        let config = { p_base: 300, p_step: 200, p_corr: 150, p_blunt: 50, p_root: 30 };
        let trialTime = 60; // 60 секунд на ознакомление

        function playSfx(isTick) {
            try {
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.frequency.setValueAtTime(isTick ? 600 : 400, ctx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(100, ctx.currentTime + 0.1);
                gain.gain.setValueAtTime(0.05, ctx.currentTime);
                gain.gain.linearRampToValueAtTime(0, ctx.currentTime + 0.1);
                osc.connect(gain); gain.connect(ctx.destination);
                osc.start(); osc.stop(ctx.currentTime + 0.1);
            } catch(e) {}
        }

        const getRef = (k) => doc(db, 'artifacts', 'dreadmetric-pro', 'public', 'data', 'keys', k);

        window.validateLicense = async (forced = null) => {
            const key = (forced || document.getElementById('keyInput').value).trim().toUpperCase();
            if(!key) return;
            
            const btn = document.getElementById('loginBtn');
            const err = document.getElementById('loginError');
            if(!forced) btn.disabled = true;

            try {
                // Всегда сначала анонимный вход для доступа к Firestore
                if(!auth.currentUser) await signInAnonymously(auth);
                
                const snap = await getDoc(getRef(key));
                if(!snap.exists()) {
                    if(!forced) { err.innerText = "Ключ не активен"; btn.disabled = false; }
                    else showAuth();
                    return;
                }

                const data = snap.data();
                const devId = localStorage.getItem('dm_dev_id') || crypto.randomUUID();
                localStorage.setItem('dm_dev_id', devId);

                // Привязка 1 телефон = 1 устройство
                if(!data.boundDeviceId || data.boundDeviceId === devId) {
                    if(!data.boundDeviceId) await updateDoc(getRef(key), { boundDeviceId: devId });
                    activeKey = key;
                    if(data.config) config = data.config;
                    localStorage.setItem('dm_saved_key', key);
                    
                    document.getElementById('authScreen').classList.add('hidden');
                    document.getElementById('trialLabel').classList.add('hidden');
                    document.getElementById('mainApp').classList.remove('hidden');
                    renderSettings();
                    calculateTotal();
                } else {
                    if(!forced) { err.innerText = "Ключ на другом устройстве"; btn.disabled = false; }
                    else showAuth();
                }
            } catch(e) {
                if(!forced) { err.innerText = "Ошибка сети. Проверьте соединение."; btn.disabled = false; }
            }
        };

        function showAuth() {
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('authScreen').classList.remove('hidden');
        }

        window.calculateTotal = () => {
            playSfx(true);
            const c = parseInt(document.getElementById('cRange').value);
            const l = parseInt(document.getElementById('lRange').value);
            document.getElementById('cVal').innerText = c;
            document.getElementById('lVal').innerText = l;

            let total = 0;
            if(svc === 'creation') {
                let p = config.p_base;
                if(l > 10) p += Math.ceil((l - 10) / 10) * config.p_step;
                total = c * p;
                if(document.getElementById('blunt').checked) total += c * config.p_blunt;
            } else {
                total = c * config.p_corr;
            }
            if(document.getElementById('root').checked) total += c * config.p_root;

            const display = document.getElementById('totalPrice');
            const startValue = parseInt(display.innerText.replace(/\s/g, '')) || 0;
            const startTime = performance.now();

            function update(t) {
                const elapsed = t - startTime;
                const progress = Math.min(elapsed / 300, 1);
                const cur = Math.floor(startValue + (total - startValue) * progress);
                display.innerText = cur.toLocaleString();
                if(progress < 1) requestAnimationFrame(update);
            }
            requestAnimationFrame(update);
        };

        window.setSvc = (s) => {
            playSfx(false);
            svc = s;
            document.getElementById('btnCr').className = s === 'creation' ? 'flex-1 py-4 text-[10px] font-bold uppercase tracking-widest rounded-xl transition-all tab-active' : 'flex-1 py-4 text-[10px] font-bold uppercase tracking-widest rounded-xl transition-all text-gray-400';
            document.getElementById('btnCo').className = s === 'correction' ? 'flex-1 py-4 text-[10px] font-bold uppercase tracking-widest rounded-xl transition-all tab-active' : 'flex-1 py-4 text-[10px] font-bold uppercase tracking-widest rounded-xl transition-all text-gray-400';
            document.getElementById('lGroup').classList.toggle('hidden', s === 'correction');
            calculateTotal();
        };

        window.toggleSettings = (v) => { playSfx(false); document.getElementById('setModal').classList.toggle('hidden', !v); };

        function renderSettings() {
            const box = document.getElementById('priceInputs');
            const labels = { p_base: 'База (10см)', p_step: 'Шаг (+10см)', p_corr: 'Коррекция (шт)', p_blunt: 'Кончик (шт)', p_root: 'Валяние (шт)' };
            box.innerHTML = Object.keys(config).map(k => `
                <div class="flex justify-between items-center border-b border-gray-50 pb-4">
                    <span class="text-[10px] uppercase font-black text-gray-300 tracking-widest">${labels[k]}</span>
                    <input type="number" id="inp_${k}" value="${config[k]}" class="text-right w-20 outline-none font-bold text-lg bg-transparent">
                </div>
            `).join('');
        }

        window.saveToCloud = async () => {
            const btn = document.getElementById('saveBtn');
            btn.innerText = "СОХРАНЕНИЕ...";
            Object.keys(config).forEach(k => config[k] = parseInt(document.getElementById('inp_'+k).value) || 0);
            try {
                await updateDoc(getRef(activeKey), { config: config });
                toggleSettings(false);
                calculateTotal();
            } catch(e) { alert("Ошибка синхронизации"); }
            btn.innerText = "СОХРАНИТЬ В ОБЛАКО";
        };

        window.onload = () => {
            const saved = localStorage.getItem('dm_saved_key');
            if(saved) {
                validateLicense(saved);
            } else {
                const bar = document.getElementById('trialLabel');
                bar.classList.remove('hidden');
                const timer = setInterval(() => {
                    trialTime--;
                    bar.style.width = (trialTime / 60 * 100) + '%';
                    if(trialTime <= 0) { 
                        clearInterval(timer); 
                        showAuth(); 
                        bar.classList.add('hidden');
                    }
                }, 1000);
                calculateTotal();
            }
        };
    </script>
</body>
</html>
